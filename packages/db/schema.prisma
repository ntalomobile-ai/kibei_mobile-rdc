// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  user_public
  collector
  moderator
  admin
}

enum SubmissionStatus {
  pending
  approved
  rejected
}

enum ReportStatus {
  open
  resolved
  dismissed
}

// Models
model User {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email     String   @unique
  passwordHash String   @map("password_hash")
  fullName  String   @map("full_name")
  phoneNumber String? @unique @map("phone_number")
  avatarUrl String?  @map("avatar_url")
  avatarStoragePath String? @map("avatar_storage_path")
  role      Role     @default(user_public)
  provinceId String?  @map("province_id") @db.Uuid
  province  Province? @relation(fields: [provinceId], references: [id])
  marketId  String?  @map("market_id") @db.Uuid
  market    Market?  @relation(fields: [marketId], references: [id])
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz()

  // Relations
  submittedPrices      Price[] @relation("PriceSubmitter")
  validatedPrices      Price[] @relation("PriceValidator")
  submittedExchangeRates ExchangeRate[] @relation("ExchangeRateSubmitter")
  validatedExchangeRates ExchangeRate[] @relation("ExchangeRateValidator")
  priceReports         PriceReport[] @relation("ReportSubmitter")
  auditLogs            AuditLog[]
  passwordResetTokens  PasswordResetToken[]

  @@index([email])
  @@index([phoneNumber])
  @@index([fullName])
  @@index([role])
  @@index([provinceId])
  @@map("users")
}

model PasswordResetToken {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime @map("expires_at") @db.Timestamptz()
  usedAt    DateTime? @map("used_at") @db.Timestamptz()
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model Province {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  code        String   @unique
  nameFr      String   @map("name_fr")
  nameSw      String   @map("name_sw")
  nameLn      String   @map("name_ln")
  descriptionFr String? @map("description_fr")
  descriptionSw String? @map("description_sw")
  descriptionLn String? @map("description_ln")
  capitalCity String?  @map("capital_city")
  population  Int?
  region      String?
  isPilot     Boolean  @default(false) @map("is_pilot")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz()

  // Relations
  users       User[]
  cities      City[]

  @@index([code])
  @@index([isPilot])
  @@map("provinces")
}

model City {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  provinceId        String   @map("province_id") @db.Uuid
  province          Province @relation(fields: [provinceId], references: [id], onDelete: Cascade)
  nameFr            String   @map("name_fr")
  nameSw            String   @map("name_sw")
  nameLn            String   @map("name_ln")
  imageUrl          String?  @map("image_url")
  imageStoragePath  String?  @map("image_storage_path")
  latitude          Decimal? @db.Decimal(10, 8)
  longitude         Decimal? @db.Decimal(11, 8)
  population        Int?
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz()

  // Relations
  markets           Market[]
  exchangeRates     ExchangeRate[]

  @@index([provinceId])
  @@map("cities")
}

model Market {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  cityId          String   @map("city_id") @db.Uuid
  city            City     @relation(fields: [cityId], references: [id], onDelete: Cascade)
  nameFr          String   @map("name_fr")
  nameSw          String   @map("name_sw")
  nameLn          String   @map("name_ln")
  descriptionFr   String?  @map("description_fr")
  descriptionSw   String?  @map("description_sw")
  descriptionLn   String?  @map("description_ln")
  locationGps     String?  @map("location_gps")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz()

  // Relations
  users           User[]
  prices          Price[]
  priceReports    PriceReport[]

  @@index([cityId])
  @@index([isActive])
  @@map("markets")
}

model Product {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  code              String   @unique
  nameFr            String   @map("name_fr")
  nameSw            String   @map("name_sw")
  nameLn            String   @map("name_ln")
  category          String
  unitFr            String   @map("unit_fr")
  unitSw            String   @map("unit_sw")
  unitLn            String   @map("unit_ln")
  imageUrl          String?  @map("image_url")
  imageStoragePath  String?  @map("image_storage_path")
  descriptionFr     String?  @map("description_fr")
  descriptionSw     String?  @map("description_sw")
  descriptionLn     String?  @map("description_ln")
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz()

  // Relations
  prices            Price[]
  priceReports      PriceReport[]

  @@index([code])
  @@index([category])
  @@index([isActive])
  @@map("products")
}

model Price {
  id              String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  productId       String            @map("product_id") @db.Uuid
  product         Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
  marketId        String            @map("market_id") @db.Uuid
  market          Market            @relation(fields: [marketId], references: [id], onDelete: Cascade)
  submittedById   String            @map("submitted_by_id") @db.Uuid
  submittedBy     User              @relation("PriceSubmitter", fields: [submittedById], references: [id])
  price           Decimal           @db.Decimal(12, 2)
  currency        String            @default("CDF")
  status          SubmissionStatus  @default(pending)
  validatedById   String?           @map("validated_by_id") @db.Uuid
  validatedBy     User?             @relation("PriceValidator", fields: [validatedById], references: [id])
  notes           String?
  createdAt       DateTime          @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt       DateTime          @updatedAt @map("updated_at") @db.Timestamptz()
  validatedAt     DateTime?         @map("validated_at") @db.Timestamptz()

  // Relations
  reports         PriceReport[]

  @@index([productId])
  @@index([marketId])
  @@index([status])
  @@index([createdAt])
  @@map("prices")
}

model ExchangeRate {
  id              String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  fromCurrency    String            @map("from_currency")
  toCurrency      String            @map("to_currency")
  rate            Decimal           @db.Decimal(15, 4)
  cityId          String?           @map("city_id") @db.Uuid
  city            City?             @relation(fields: [cityId], references: [id])
  source          String?
  submittedById   String            @map("submitted_by_id") @db.Uuid
  submittedBy     User              @relation("ExchangeRateSubmitter", fields: [submittedById], references: [id])
  status          SubmissionStatus  @default(pending)
  validatedById   String?           @map("validated_by_id") @db.Uuid
  validatedBy     User?             @relation("ExchangeRateValidator", fields: [validatedById], references: [id])
  notes           String?
  createdAt       DateTime          @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt       DateTime          @updatedAt @map("updated_at") @db.Timestamptz()
  validatedAt     DateTime?         @map("validated_at") @db.Timestamptz()

  @@unique([fromCurrency, toCurrency, cityId, createdAt])
  @@index([fromCurrency, toCurrency])
  @@index([cityId])
  @@index([status])
  @@index([createdAt])
  @@map("exchange_rates")
}

model PriceReport {
  id            String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  
  // Lien optionnel à un prix existant (pour signaler un prix spécifique)
  priceId       String?      @map("price_id") @db.Uuid
  price         Price?       @relation(fields: [priceId], references: [id], onDelete: Cascade)
  
  // OU signalement libre avec produit/marché/prix observé
  productId     String?      @map("product_id") @db.Uuid
  product       Product?     @relation(fields: [productId], references: [id])
  marketId      String?      @map("market_id") @db.Uuid
  market        Market?      @relation(fields: [marketId], references: [id])
  observedPrice Decimal?     @map("observed_price") @db.Decimal(12, 2)
  currency      String?      @default("CDF")
  
  // Informations du signalement
  reportedById  String       @map("reported_by_id") @db.Uuid
  reportedBy    User         @relation("ReportSubmitter", fields: [reportedById], references: [id])
  reasonFr      String       @map("reason_fr")
  reasonSw      String       @map("reason_sw")
  reasonLn      String       @map("reason_ln")
  
  // Statut et traitement
  status        ReportStatus @default(open)
  priority      String?      @default("normal") // low, normal, high, urgent
  resolvedNotes String?      @map("resolved_notes")
  transmittedToAuthorities Boolean @default(false) @map("transmitted_to_authorities")
  transmittedAt DateTime?    @map("transmitted_at") @db.Timestamptz()
  
  createdAt     DateTime     @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt     DateTime     @updatedAt @map("updated_at") @db.Timestamptz()
  resolvedAt    DateTime?    @map("resolved_at") @db.Timestamptz()

  @@index([priceId])
  @@index([productId])
  @@index([marketId])
  @@index([status])
  @@index([transmittedToAuthorities])
  @@map("price_reports")
}

model AuditLog {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  user      User?    @relation(fields: [userId], references: [id])
  action    String
  tableName String   @map("table_name")
  recordId  String?  @map("record_id") @db.Uuid
  oldValues Json?    @map("old_values")
  newValues Json?    @map("new_values")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()

  @@index([userId])
  @@index([tableName])
  @@index([createdAt])
  @@map("audit_logs")
}
